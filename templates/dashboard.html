<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets</title>
  <link rel="preconnect" href="https://www.morabets.com">
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--green:#2dd36f;--amber:#f9d65a;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
    .tab{background:transparent;color:var(--muted);border:1px solid var(--stroke);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{color:var(--text);border-color:#7c6dff;box-shadow:0 0 0 1px #7c6dff inset}
    .search{width:100%;max-width:420px;padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--text)}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;color:#cbd3ee}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .tiny-link{display:inline-flex;align-items:center;gap:6px;color:#9dd0ff;font-size:12px;cursor:pointer;text-decoration:none;border-bottom:1px dashed #2b3245}
    .tiny-link:hover{color:#cfe6ff}
    
    .edge-badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #1e9d59;   /* green-ish */
      color: #fff;
      margin-left: 8px;
      line-height: 18px;
      user-select: none;
    }
    
    /* Hide market tabs (defensive) */
    #market-tabs { display: none !important; }
    
    /* big loading overlay */
    .loading{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(10,14,24,.85);backdrop-filter:saturate(140%) blur(2px);
      z-index:10;flex-direction:column;text-align:center;padding:24px
    }
    .spinner{width:44px;height:44px;border:3px solid #2b3245;border-top-color:#9dd0ff;border-radius:50%;animation:spin 0.9s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="font-weight:700">Loading 1,000+ props…</div>
    <div class="muted" style="margin-top:6px">This can take a few seconds on first load.</div>
  </div>

  <div class="wrap">
    <div class="top">
      <h1>Mora Bets</h1>
      <div class="muted"><span id="count">–</span> props</div>
    </div>

    <!-- League tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-league="mlb">MLB</button>
      <button class="tab" data-league="nfl">NFL</button>
      <button class="tab" data-league="nba">NBA</button>
      <button class="tab" data-league="nhl">NHL</button>
      <button class="tab" data-league="ufc">UFC</button>
      <button class="tab" data-league="ncaa">NCAA</button>
    </div>

    <div class="toolbar">
      <input id="q" class="search" placeholder="Search players or stats…" />
      <div id="sortMode" class="tabs" style="margin-left:auto">
        <button id="sortFair" class="tab sorttab" data-sort="fair">Fair</button>
        <button id="sortEdge" class="tab sorttab" data-sort="edge">AI Edge Finder</button>
      </div>
    </div>

    <div id="props" class="grid"></div>
  </div>



<script>
(async function(){
  const grid = document.getElementById('props');
  const countEl = document.getElementById('count');
  const q = document.getElementById('q');
  const tabs = document.getElementById('tabs');
  const loader = document.getElementById('loading');

  let league = 'mlb';
  const today = new Date().toISOString().slice(0,10);
  
  // Set AI edge threshold globally
  window.AI_MIN_EDGE = 0.06;

  const esc = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const pct = (x)=> Math.round((Number(x)||0)*100);
  function americanToProb(odds){ if(odds==null) return 0; const o=Number(odds); if(!isFinite(o)||o===0) return 0; return o>0?100/(o+100):(-o)/(100-o); }

  // Derive a nice matchup string from a prop, with fallbacks.
  function computeMatchup(p) {
    // Direct fields first
    if (typeof p.matchup === 'string' && p.matchup.trim()) return p.matchup.trim();
    if (typeof p.game === 'string' && p.game.trim()) return p.game.trim();

    // Common shapes
    const away = p.away || p.away_team || p.teams?.away || p.opp_team || p.opponent;
    const home = p.home || p.home_team || p.teams?.home;
    if (away && home) return `${away} @ ${home}`;

    // Team vs opp fallback
    const team = p.team || p.player_team || p.team_name;
    const opp  = p.opponent || p.opp || p.opp_team;
    if (team && opp) {
      // If you have a home/away marker, use it to pick @ vs vs
      const ha = (p.home_away === 'home' || p.is_home === true) ? 'vs' : '@';
      return `${team} ${ha} ${opp}`;
    }

    // Last resort
    const lg = (p.league || '').toUpperCase();
    return lg ? `${lg} Game` : 'Game`;
  }

  // -------------- sorting logic --------------
  let SORTMODE = localStorage.getItem('sortMode') || 'fair';
  let PROPS_CACHE = []; // last fetched list

  function sortProps(props, mode) {
    if (mode === 'edge') {
      // Highest AI edge first; if no ai, fall back to fair prob
      return [...props].sort((a, b) => {
        const ea = Number(a.ai?.edge_over ?? 0);
        const eb = Number(b.ai?.edge_over ?? 0);
        if (eb !== ea) return eb - ea;
        const fa = Number(a.fair?.prob?.over ?? 0);
        const fb = Number(b.fair?.prob?.over ?? 0);
        return fb - fa;
      });
    }
    // default: market fair prob (desc)
    return [...props].sort((a, b) =>
      Number(b.fair?.prob?.over ?? 0) - Number(a.fair?.prob?.over ?? 0)
    );
  }

  function resortAndRender(){
    const arr = sortProps(PROPS_CACHE, SORTMODE);
    countEl.textContent = arr.length.toLocaleString();
    grid.innerHTML = arr.length ? arr.map(renderCard).join('') : `<div class="card"><div class="muted">No props found.</div></div>`;
  }

  (function initSortToggle(){
    const bar = document.getElementById('sortMode');
    if (!bar) return;
    function sync(){
      document.getElementById('sortFair')?.classList.toggle('active', SORTMODE === 'fair');
      document.getElementById('sortEdge')?.classList.toggle('active', SORTMODE === 'edge');
    }
    bar.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-sort]');
      if (!btn) return;
      SORTMODE = btn.dataset.sort;
      localStorage.setItem('sortMode', SORTMODE);
      sync();
      resortAndRender(); // re-rank instantly, no refetch
    });
    sync();
  })();

  // NEW: map FE stat names to backend's expected names (batter_* etc.)
  function mapStatForContext(s){
    const t = String(s||'').toLowerCase();
    const m = {
      // batter stats
      "hits":"batter_hits",
      "total_bases":"batter_total_bases",
      "tb":"batter_total_bases",
      "home_runs":"batter_home_runs",
      "runs":"batter_runs",
      "rbi":"batter_runs_batted_in",
      "walks":"batter_walks",
      "stolen_bases":"batter_stolen_bases",
      // pitching (if rendered)
      "strikeouts":"pitcher_strikeouts",
      "earned_runs":"pitcher_earned_runs",
      "hits_allowed":"pitcher_hits_allowed",
      "outs":"pitcher_outs",
      "walks_allowed":"pitcher_walks"
    };
    return m[t] || s;
  }

  function flatten(data){
    if(Array.isArray(data)) return data;
    if(data && typeof data==='object'){
      const out=[]; for(const [k, arr] of Object.entries(data)){ if(Array.isArray(arr)) for(const p of arr){ out.push({...p, matchup:k}); } }
      return out;
    }
    return [];
  }

  function scoreOver(p){
    const fair = p?.fair?.prob?.over ?? 0;
    return (fair && fair>0) ? fair : americanToProb(p?.odds);
  }



  function renderCard(p){
    const over = pct(p?.fair?.prob?.over ?? 0);
    const under = pct(p?.fair?.prob?.under ?? 0);
    const src = (p?.fair?.book || p?.shop || '').toString().toUpperCase();
    const stat = (p?.stat ?? '').toString();
    
    return `
      <div class="card" data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc(stat.toLowerCase())}">
        <div class="row">
          <div class="muted">${esc(computeMatchup(p))}</div>
          <div class="pill">${esc(stat)} ${esc(p.line)}</div>
        </div>
        <div style="margin-top:8px;font-weight:700">
          ${esc(p.player || '')}
          ${(() => {
            const edge = p.ai?.edge_over ?? 0;
            const th   = Number(window.AI_MIN_EDGE ?? 0.06);  // set once on page load or hardcode
            if (edge >= th) {
              const pct = Math.round(edge * 100);
              return `<span class="edge-badge">Edge +${pct}%</span>`;
            }
            return '';
          })()}
        </div>
        <div style="margin-top:10px">
          <div class="over">Over ${over}%</div>
          <div class="under">Under ${under}%</div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">${src ? `Source: ${esc(src)}` : ''}</div>
      </div>
    `;
  }

  async function fetchAllProps(){
    const urls = [
      `/player_props?league=${league}&date=${today}`,
      `/player_props?league=${league}`
    ];
    for(const url of urls){
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) continue;
        const json = await res.json();
        return flatten(json);
      }catch(e){}
    }
    return [];
  }

  async function loadLeague(newLeague){
    league = newLeague || league;
    Array.from(tabs.querySelectorAll('.tab')).forEach(b=> b.classList.toggle('active', b.dataset.league===league));
    loader.style.display = 'flex';
    grid.innerHTML = '';
    countEl.textContent = '–';

    const all = await fetchAllProps();
    PROPS_CACHE = all;
    resortAndRender();
    loader.style.display = 'none';
  }

  // search filter
  q.addEventListener('input', ()=>{
    const term=(q.value||'').trim().toLowerCase();
    for(const el of grid.children){
      if(!term){ el.style.display=''; continue; }
      const name=el.getAttribute('data-name')||'';
      const stat=el.getAttribute('data-stat')||'';
      el.style.display=(name.includes(term)||stat.includes(term))?'':'none';
    }
  });

  // tabs
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab'); if(!btn) return;
    if(btn.dataset.league === league) return;
    loadLeague(btn.dataset.league);
  });

  // Put this near your other globals
  const API_BASE = ""; // same-origin API; if your backend is on another host, set it explicitly

  // initial load
  loadLeague('mlb');
})();



// ------------- STAT SUGGESTIONS FUNCTIONALITY -------------
(() => {
  // ---------- Config ----------
  const MAP = (() => {
    const m = {
      mlb: [
        "batter_hits","player_hits",
        "player_total_bases","player_home_runs","player_rbis","player_runs","player_stolen_bases",
        "pitcher_strikeouts","pitcher_outs","pitcher_hits_allowed","pitcher_walks","pitcher_earned_runs"
      ],
      nfl: [
        "player_pass_yds","player_pass_tds",
        "player_rush_yds","player_rush_attempts","player_rush_tds",
        "player_reception_yds","player_receptions","player_reception_tds",
        "player_anytime_td"
      ],
      ncaaf: [
        "player_pass_yds","player_pass_tds",
        "player_rush_yds","player_rush_attempts","player_rush_tds",
        "player_reception_yds","player_receptions","player_reception_tds",
        "player_anytime_td"
      ],
      ufc: ["fight_total_rounds"],
      nba: [],
      nhl: []
    };
    // de-dup + alpha sort for cleanliness
    for (const k of Object.keys(m)) {
      m[k] = Array.from(new Set(m[k])).sort((a,b)=>a.localeCompare(b));
    }
    return m;
  })();

  // ---------- Remove/hide old market pills if present ----------
  document.addEventListener('DOMContentLoaded', () => {
    const old = document.getElementById('market-tabs');
    if (old && old.parentNode) old.parentNode.removeChild(old);
  });
  window.reRenderWithMarketFilter = window.reRenderWithMarketFilter || function(){};

  // ---------- Datalist wiring ----------
  function ensureDatalist() {
    let dl = document.getElementById('stat-suggestions');
    if (!dl) {
      dl = document.createElement('datalist');
      dl.id = 'stat-suggestions';
      document.body.appendChild(dl);
    }
    const input = document.querySelector('.search');
    if (input && input.getAttribute('list') !== 'stat-suggestions') {
      input.setAttribute('list', 'stat-suggestions');
      // keep your existing search handler untouched
    }
    return dl;
  }

  function setSuggestions(league) {
    const dl = ensureDatalist();
    const key = (league||'mlb').toLowerCase();
    const items = MAP[key] || [];
    dl.innerHTML = items.map(v => `<option value="${v}"></option>`).join('');
  }

  // ---------- Detect active league on load ----------
  function detectInitialLeague() {
    const active = document.querySelector('.tabs .tab.active');
    if (!active) return 'mlb';
    const t = (active.textContent||'').trim().toLowerCase();
    return ['mlb','nfl','ncaaf','ufc','nba','nhl'].includes(t) ? t : 'mlb';
  }

  // ---------- Integrate with existing league change flow ----------
  function wrapLoadLeagueOnce() {
    const fn = window.loadLeague;
    if (typeof fn === 'function' && !fn.__wrapped_for_suggestions__) {
      window.loadLeague = async function(league, ...rest) {
        const result = await fn.call(this, league, ...rest);
        setSuggestions(league);
        return result;
      };
      window.loadLeague.__wrapped_for_suggestions__ = true;
    }
  }

  // Fallback: listen for clicks on league tabs
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tabs .tab');
    if (!btn) return;
    const t = (btn.textContent||'').trim().toLowerCase();
    if (['mlb','nfl','ncaaf','ufc','nba','nhl'].includes(t)) {
      setSuggestions(t);
    }
  });

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded', () => {
    wrapLoadLeagueOnce();
    setSuggestions(detectInitialLeague());
  });
})();
</script>
</body>
</html>
