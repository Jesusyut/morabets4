<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mora Bets</title>
  <link rel="preconnect" href="https://www.morabets.com">
  <style>
    :root{--bg:#0f1420;--card:#161b28;--stroke:#2b3245;--text:#e6e9f2;--muted:#9aa4bf;--green:#2dd36f;--amber:#f9d65a;}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
    .tab{background:transparent;color:var(--muted);border:1px solid var(--stroke);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{color:var(--text);border-color:#7c6dff;box-shadow:0 0 0 1px #7c6dff inset}
    .search{width:100%;max-width:420px;padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--text)}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{font-size:12px;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;color:#cbd3ee}
    .over{color:var(--green);font-weight:600}
    .under{color:var(--amber)}
    .tiny-link{display:inline-flex;align-items:center;gap:6px;color:#9dd0ff;font-size:12px;cursor:pointer;text-decoration:none;border-bottom:1px dashed #2b3245}
    .tiny-link:hover{color:#cfe6ff}
    
    /* Hide market tabs (defensive) */
    #market-tabs { display: none !important; }
    
    /* big loading overlay */
    .loading{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(10,14,24,.85);backdrop-filter:saturate(140%) blur(2px);
      z-index:10;flex-direction:column;text-align:center;padding:24px
    }
    .spinner{width:44px;height:44px;border:3px solid #2b3245;border-top-color:#9dd0ff;border-radius:50%;animation:spin 0.9s linear infinite;margin-bottom:12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="font-weight:700">Loading 1,000+ props…</div>
    <div class="muted" style="margin-top:6px">This can take a few seconds on first load.</div>
  </div>

  <div class="wrap">
    <div class="top">
      <h1>Mora Bets</h1>
      <div class="muted"><span id="count">–</span> props</div>
    </div>

    <!-- League tabs -->
    <div class="tabs" id="tabs">
      <button class="tab active" data-league="mlb">MLB</button>
      <button class="tab" data-league="nfl">NFL</button>
      <button class="tab" data-league="nba">NBA</button>
      <button class="tab" data-league="nhl">NHL</button>
      <button class="tab" data-league="ufc">UFC</button>
      <button class="tab" data-league="ncaa">NCAA</button>
    </div>

    <div class="toolbar">
      <input id="q" class="search" placeholder="Search players or stats…" />
      <div id="sortMode" class="tabs" style="margin-left:auto">
        <button id="sortOver"  class="tab sorttab" data-sort="over">Over</button>
        <button id="sortUnder" class="tab sorttab" data-sort="under">Under</button>
      </div>
    </div>

    <div id="props" class="grid"></div>
  </div>

  <!-- trend modal -->
  <div id="trendModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trendTitle" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px">
    <div class="modal-card" style="background:#0e1422;border:1px solid #2b3245;border-radius:14px;max-width:520px;width:100%;padding:16px">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div id="trendTitle" style="font-weight:700"></div>
          <div id="trendSub" class="muted" style="font-size:12px"></div>
        </div>
        <button class="close" onclick="trendClose()" style="background:transparent;color:#9aa4bf;border:1px solid #2b3245;padding:6px 10px;border-radius:8px;cursor:pointer">Close</button>
      </div>
      <div id="trendBody" class="muted">Loading…</div>
      <div class="kpi" id="trendKPI" style="display:none;gap:10px;flex-wrap:wrap;margin-top:8px"></div>
    </div>
  </div>

<script>
(async function(){
  const grid = document.getElementById('props');
  const countEl = document.getElementById('count');
  const q = document.getElementById('q');
  const tabs = document.getElementById('tabs');
  const loader = document.getElementById('loading');

  let league = 'mlb';
  const today = new Date().toISOString().slice(0,10);

  const esc = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  const pct = (x)=> Math.round((Number(x)||0)*100);
  function americanToProb(odds){ if(odds==null) return 0; const o=Number(odds); if(!isFinite(o)||o===0) return 0; return o>0?100/(o+100):(-o)/(100-o); }

  // -------------- tiny additions for toggle --------------
  let SORTMODE = localStorage.getItem('sortMode') || 'over';
  let PROPS_CACHE = []; // last fetched list

  function scoreUnder(p){
    const u = p?.fair?.prob?.under ?? null;
    if (typeof u === 'number' && u >= 0) return u;      // real under prob
    const o = p?.fair?.prob?.over ?? null;              // fallback if only 'over' exists
    return (typeof o === 'number') ? (1 - o) : 0;
  }

  function resortAndRender(){
    const cmp = (a,b) => SORTMODE === 'under'
      ? (scoreUnder(b) - scoreUnder(a))
      : ((p=>p?.fair?.prob?.over ?? 0)(b) - (p=>p?.fair?.prob?.over ?? 0)(a));
    const arr = PROPS_CACHE.slice().sort(cmp);
    countEl.textContent = arr.length.toLocaleString();
    grid.innerHTML = arr.length ? arr.map(renderCard).join('') : `<div class="card"><div class="muted">No props found.</div></div>`;
    if (typeof prefetchL10ForVisibleCards === 'function') prefetchL10ForVisibleCards(90);
  }

  (function initSortToggle(){
    const bar = document.getElementById('sortMode');
    if (!bar) return;
    function sync(){
      document.getElementById('sortOver')?.classList.toggle('active', SORTMODE === 'over');
      document.getElementById('sortUnder')?.classList.toggle('active', SORTMODE === 'under');
    }
    bar.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-sort]');
      if (!btn) return;
      SORTMODE = btn.dataset.sort;
      localStorage.setItem('sortMode', SORTMODE);
      sync();
      resortAndRender(); // re-rank instantly, no refetch
    });
    sync();
  })();

  // NEW: map FE stat names to backend's expected names (batter_* etc.)
  function mapStatForContext(s){
    const t = String(s||'').toLowerCase();
    const m = {
      // batter stats
      "hits":"batter_hits",
      "total_bases":"batter_total_bases",
      "tb":"batter_total_bases",
      "home_runs":"batter_home_runs",
      "runs":"batter_runs",
      "rbi":"batter_runs_batted_in",
      "walks":"batter_walks",
      "stolen_bases":"batter_stolen_bases",
      // pitching (if rendered)
      "strikeouts":"pitcher_strikeouts",
      "earned_runs":"pitcher_earned_runs",
      "hits_allowed":"pitcher_hits_allowed",
      "outs":"pitcher_outs",
      "walks_allowed":"pitcher_walks"
    };
    return m[t] || s;
  }

  function flatten(data){
    if(Array.isArray(data)) return data;
    if(data && typeof data==='object'){
      const out=[]; for(const [k, arr] of Object.entries(data)){ if(Array.isArray(arr)) for(const p of arr){ out.push({...p, matchup:k}); } }
      return out;
    }
    return [];
  }

  function scoreOver(p){
    const fair = p?.fair?.prob?.over ?? 0;
    return (fair && fair>0) ? fair : americanToProb(p?.odds);
  }

  function trendLinkHTML(p){
    return `<a class="tiny-link" onclick="showTrend(${encodeURIComponent(JSON.stringify({player:p.player, stat:p.stat, line:p.line}))})">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 6 12 13 7 10 2 13"></polyline><polyline points="22 10 12 17 7 14 2 17"></polyline></svg>
      Show last 10 games trend
    </a>`;
  }

  function renderCard(p){
    const over = pct(p?.fair?.prob?.over ?? 0);
    const under = pct(p?.fair?.prob?.under ?? 0);
    const src = (p?.fair?.book || p?.shop || '').toString().toUpperCase();
    const stat = (p?.stat ?? '').toString();
    
    // Include meta.l10 data if available
    const metaL10 = p?.meta?.l10 ? ` data-meta-l10="${esc(JSON.stringify(p.meta.l10))}"` : '';
    
    return `
      <div class="card" data-name="${esc((p.player||'').toLowerCase())}" data-stat="${esc(stat.toLowerCase())}"${metaL10}>
        <div class="row">
          <div class="muted">${esc(p.matchup || '')}</div>
          <div class="pill">${esc(stat)} ${esc(p.line)}</div>
        </div>
        <div style="margin-top:8px;font-weight:700">${esc(p.player || '')}</div>
        <div style="margin-top:8px">${trendLinkHTML(p)}</div>
        <div style="margin-top:10px">
          <div class="over">Over ${over}%</div>
          <div class="under">Under ${under}%</div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">${src ? `Source: ${esc(src)}` : ''}</div>
      </div>
    `;
  }

  async function fetchAllProps(){
    const urls = [
      `/player_props?league=${league}&date=${today}`,
      `/player_props?league=${league}`
    ];
    for(const url of urls){
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) continue;
        const json = await res.json();
        return flatten(json);
      }catch(e){}
    }
    return [];
  }

  async function loadLeague(newLeague){
    league = newLeague || league;
    Array.from(tabs.querySelectorAll('.tab')).forEach(b=> b.classList.toggle('active', b.dataset.league===league));
    loader.style.display = 'flex';
    grid.innerHTML = '';
    countEl.textContent = '–';

    const all = await fetchAllProps();
    PROPS_CACHE = all;
    resortAndRender();
    loader.style.display = 'none';
  }

  // search filter
  q.addEventListener('input', ()=>{
    const term=(q.value||'').trim().toLowerCase();
    for(const el of grid.children){
      if(!term){ el.style.display=''; continue; }
      const name=el.getAttribute('data-name')||'';
      const stat=el.getAttribute('data-stat')||'';
      el.style.display=(name.includes(term)||stat.includes(term))?'':'none';
    }
  });

  // tabs
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab'); if(!btn) return;
    if(btn.dataset.league === league) return;
    loadLeague(btn.dataset.league);
  });

  // Put this near your other globals
  const API_BASE = ""; // same-origin API; if your backend is on another host, set it explicitly

  // ---- Trend modal plumbing ----
  window.trendClose = function(){ document.getElementById('trendModal').style.display = 'none'; };
  window.showTrend = async function(encoded){
    const payload = JSON.parse(decodeURIComponent(encoded));
    const {player, stat, line} = payload || {};
    const modal = document.getElementById('trendModal');
    const title = document.getElementById('trendTitle');
    const sub = document.getElementById('trendSub');
    const body = document.getElementById('trendBody');
    const kpi = document.getElementById('trendKPI');

    title.textContent = player || '';
    sub.textContent = `${stat ?? ''} ${line ?? ''}`;
    body.textContent = 'Loading…';
    kpi.style.display = 'none'; kpi.innerHTML = '';
    modal.style.display = 'flex';

    // Check if we have cached data first (from server meta.l10 or frontend dataset.l10)
    const card = Array.from(document.querySelectorAll('.card'))
      .find(el => el.querySelector('.pill')?.textContent?.includes(`${stat} ${line}`) &&
                  el.querySelector('div[style*="font-weight:700"]')?.textContent === player);
    
    // Check frontend cache first, then server meta.l10
    let cached = null;
    if (card?.dataset?.l10) {
      cached = JSON.parse(card.dataset.l10);
    } else if (card?.getAttribute('data-meta-l10')) {
      // Server-provided meta.l10 data
      cached = JSON.parse(card.getAttribute('data-meta-l10'));
    }
    
    if (cached) {
      const rate = Number(cached.hit_rate || cached.rate_over || 0);
      const size = Number(cached.sample_size || cached.games || 10);
      const conf = cached.confidence || '';
      body.innerHTML = `Over in <b>${Math.round(rate*size)}</b> of last <b>${size}</b> games (${Math.round(rate*100)}%)`;
      kpi.style.display = 'flex';
      kpi.innerHTML = `<div>Confidence: <b>${conf}</b></div><div>Threshold: <b>${(cached.threshold ?? line ?? 1)}</b></div>`;
      return; // no network needed
    }

    // inside showTrend(), before the fetch loop:
    const mapped = mapStatForContext(stat);
    const qs = new URLSearchParams({
      player_name: player || '',
      stat_type: mapped || '',
      threshold: (line ?? 1).toString()
    });
    const url = `${API_BASE}/contextual/hit_rate?${qs.toString()}`;
    console.log("[L10] fetch", url);

    // replace the multi-URL loop with a single exact route:
    let resp = null;
    try {
      const r = await fetch(url, { credentials: "omit" });
      if (r.ok) resp = await r.json();
    } catch(e) {
      console.error("[L10] fetch failed:", e);
    }
    if (!resp) { body.textContent='Could not load last 10 games.'; return; }

    const rate = Number(resp.hit_rate ?? 0);
    const size = Number(resp.sample_size ?? 10);
    const conf = resp.confidence || '';
    body.innerHTML = `Over in <b>${Math.round(rate*size)}</b> of last <b>${size}</b> games (${Math.round(rate*100)}%)`;
    kpi.style.display = 'flex';
    kpi.innerHTML = `<div>Confidence: <b>${conf}</b></div><div>Threshold: <b>${(resp.threshold ?? line ?? 1)}</b></div>`;
  };

  // initial load
  loadLeague('mlb');
})();

// define once, above prefetchL10ForVisibleCards
function mapStatForContext(statKey, line) {
  const k = String(statKey || '').toLowerCase();
  const th = Number(line) || 1;
  if (k.includes('batter_hits')) return { stat: 'hits', threshold: Math.max(1, Math.round(th)) };
  if (k.includes('batter_total_bases')) return { stat: 'total_bases', threshold: th };
  if (k.includes('batter_home_runs')) return { stat: 'home_runs', threshold: th || 1 };
  if (k.includes('batter_rbis')) return { stat: 'rbi', threshold: th || 1 };
  if (k.includes('batter_runs_scored')) return { stat: 'runs', threshold: th || 1 };
  return null; // unknown stat -> skip prefetch
}

function inViewport(el){
  const r = el.getBoundingClientRect();
  return r.top < window.innerHeight && r.bottom > 0;
}

async function prefetchL10ForVisibleCards() {
  const cards = [...document.querySelectorAll('.prop-card')].filter(inViewport);
  const jobs = cards.map(async (card) => {
    try {
      if (card.dataset.trendLoaded === '1') return;
      const mapped = mapStatForContext(card.dataset.stat, card.dataset.line);
      if (!mapped) return;
      const url = `/api/trends/l10?player=${encodeURIComponent(card.dataset.player)}&stat=${mapped.stat}&threshold=${mapped.threshold}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) return;
      const data = await res.json();
      renderTrend(card, data);
      card.dataset.trendLoaded = '1';
    } catch (e) {
      console.debug('prefetchL10 error', e);
    }
  });
  await Promise.allSettled(jobs);
}

// optional: debounce to avoid hammering on scroll
const debounce = (fn, ms=300) => {
  let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
};
window.addEventListener('load', prefetchL10ForVisibleCards);
document.addEventListener('scroll', debounce(prefetchL10ForVisibleCards, 300), { passive: true });

// ------------- STAT SUGGESTIONS FUNCTIONALITY -------------
(() => {
  // ---------- Config ----------
  const MAP = (() => {
    const m = {
      mlb: [
        "batter_hits","player_hits",
        "player_total_bases","player_home_runs","player_rbis","player_runs","player_stolen_bases",
        "pitcher_strikeouts","pitcher_outs","pitcher_hits_allowed","pitcher_walks","pitcher_earned_runs"
      ],
      nfl: [
        "player_pass_yds","player_pass_tds",
        "player_rush_yds","player_rush_attempts","player_rush_tds",
        "player_reception_yds","player_receptions","player_reception_tds",
        "player_anytime_td"
      ],
      ncaaf: [
        "player_pass_yds","player_pass_tds",
        "player_rush_yds","player_rush_attempts","player_rush_tds",
        "player_reception_yds","player_receptions","player_reception_tds",
        "player_anytime_td"
      ],
      ufc: ["fight_total_rounds"],
      nba: [],
      nhl: []
    };
    // de-dup + alpha sort for cleanliness
    for (const k of Object.keys(m)) {
      m[k] = Array.from(new Set(m[k])).sort((a,b)=>a.localeCompare(b));
    }
    return m;
  })();

  // ---------- Remove/hide old market pills if present ----------
  document.addEventListener('DOMContentLoaded', () => {
    const old = document.getElementById('market-tabs');
    if (old && old.parentNode) old.parentNode.removeChild(old);
  });
  window.reRenderWithMarketFilter = window.reRenderWithMarketFilter || function(){};

  // ---------- Datalist wiring ----------
  function ensureDatalist() {
    let dl = document.getElementById('stat-suggestions');
    if (!dl) {
      dl = document.createElement('datalist');
      dl.id = 'stat-suggestions';
      document.body.appendChild(dl);
    }
    const input = document.querySelector('.search');
    if (input && input.getAttribute('list') !== 'stat-suggestions') {
      input.setAttribute('list', 'stat-suggestions');
      // keep your existing search handler untouched
    }
    return dl;
  }

  function setSuggestions(league) {
    const dl = ensureDatalist();
    const key = (league||'mlb').toLowerCase();
    const items = MAP[key] || [];
    dl.innerHTML = items.map(v => `<option value="${v}"></option>`).join('');
  }

  // ---------- Detect active league on load ----------
  function detectInitialLeague() {
    const active = document.querySelector('.tabs .tab.active');
    if (!active) return 'mlb';
    const t = (active.textContent||'').trim().toLowerCase();
    return ['mlb','nfl','ncaaf','ufc','nba','nhl'].includes(t) ? t : 'mlb';
  }

  // ---------- Integrate with existing league change flow ----------
  function wrapLoadLeagueOnce() {
    const fn = window.loadLeague;
    if (typeof fn === 'function' && !fn.__wrapped_for_suggestions__) {
      window.loadLeague = async function(league, ...rest) {
        const result = await fn.call(this, league, ...rest);
        setSuggestions(league);
        return result;
      };
      window.loadLeague.__wrapped_for_suggestions__ = true;
    }
  }

  // Fallback: listen for clicks on league tabs
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tabs .tab');
    if (!btn) return;
    const t = (btn.textContent||'').trim().toLowerCase();
    if (['mlb','nfl','ncaaf','ufc','nba','nhl'].includes(t)) {
      setSuggestions(t);
    }
  });

  // ---------- Boot ----------
  document.addEventListener('DOMContentLoaded', () => {
    wrapLoadLeagueOnce();
    setSuggestions(detectInitialLeague());
  });
})();
</script>
</body>
</html>
